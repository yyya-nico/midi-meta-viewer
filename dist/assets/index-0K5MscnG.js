(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&t(f)}).observe(document,{childList:!0,subtree:!0});function l(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(n){if(n.ep)return;n.ep=!0;const r=l(n);fetch(n.href,r)}})();const S=document.getElementById("file-input"),X=document.querySelector(".file-input-text"),C=document.getElementById("meta-view"),L={3:"曲名",2:"著作権",1:"テキスト",5:"歌詞",6:"マーカー",7:"キューポイント"},b={XFhd:["ID","発表年月日","制作地","曲のジャンル","リズムのビート","メロディーパートの主な楽器","歌唱タイプ","作曲者","作詞者","編曲者","演奏者/歌唱者","楽曲データ制作者","キーワード"],XFln:["ID","言語情報","曲名","作曲者","作詞者","編曲者","演奏者/歌唱者","楽曲データ制作者"]};function T(e,d){let l=0,t=d;for(;;){const n=e[t++];if(l=l<<7|n&127,(n&128)===0)break}return{value:l,next:t}}const O=e=>{if(!(e[0]===77&&e[1]===84&&e[2]===104&&e[3]===100))throw new Error("MIDIファイルではありません。");const l=[];let t=14,n=0;for(;t<e.length;){if(!(e[t]===77&&e[t+1]===84&&e[t+2]===114&&e[t+3]===107||e[t]===88&&e[t+1]===70&&e[t+2]===73&&e[t+3]===72)){t++;continue}const f=e[t+4]<<24|e[t+5]<<16|e[t+6]<<8|e[t+7];let o=t+8;const y=o+f;let c=[],u=0;for(;o<y;){const{next:m}=T(e,o);o=m;let i=e[o];if(i<128?i=u:(o++,u=i),i===255){const s=e[o++],{value:p,next:x}=T(e,o);if(o=x,L[s]){const E=n>0&&L[s]==="曲名"?"トラック名":L[s],a=new TextDecoder("Shift-JIS").decode(e.slice(o,o+p)),h=a.slice(0,4);if(h==="XFhd"||h==="XFln"){const v=a.split(":"),D=b[h],g=h==="XFhd"?"共通":"言語別";let I={共通:[],言語別:[]};for(const[w,M]of v.entries())w>0&&D[w]&&M&&I[g].push({type:D[w],text:M});const F=c[c.length-1];F&&F.type==="XF"?F.info[g].push(...I[g]):c.push({type:"XF",info:I})}else a&&c.push({type:E,text:a})}if(s===47&&p===0)break;o+=p}else if(i>=128&&i<=239){const s=i&240;s===192||s===208?o+=1:o+=2}else if(i===240||i===247){const{value:s,next:p}=T(e,o);o=p+s}else o++}l.push({track:n+1,meta:c}),n++,t=y}C.textContent="";let r=!1;for(const f of l){if(f.meta.length===0)continue;r=!0;const o=document.createElement("fieldset"),y=document.createElement("legend");y.textContent=`Track ${f.track}`,o.appendChild(y);const c=document.createElement("dl");for(const u of f.meta)if(u.type==="XF"){const m=u.info;for(const i of["共通","言語別"])if(m[i].length>0){const s=document.createElement("dt");s.textContent=`XF項目（${i}）`,c.appendChild(s);const p=document.createElement("dd"),x=document.createElement("dl");for(const E of m[i]){const a=document.createElement("dt");a.textContent=E.type;const h=document.createElement("dd");h.textContent=E.text,x.appendChild(a),x.appendChild(h)}p.appendChild(x),c.appendChild(p)}}else if("text"in u){const m=document.createElement("dt");m.textContent=u.type;const i=document.createElement("dd");i.textContent=u.text,c.appendChild(m),c.appendChild(i)}o.appendChild(c),C.appendChild(o)}r||(C.textContent="メタ情報が見つかりませんでした。")},k=X.textContent;S.addEventListener("change",async()=>{const e=S.files?.[0];if(e){X.textContent=e.name;const d=new Uint8Array(await e.arrayBuffer());try{O(d)}catch(l){C.textContent=l.message||"MIDIファイルの解析に失敗しました。"}}else X.textContent=k,C.textContent=""});
